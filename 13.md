# ç”©é”…æ³•ç¼–ç¨‹

è‡ªå¤–å‘å†…çš„ TDD, å…¶å®å°±æ˜¯æˆ‘ä»¬ä¸€ç›´åšçš„, å…ˆå†™åŠŸèƒ½æµ‹è¯•, ç„¶åå•å…ƒæµ‹è¯•. æˆ‘ä»¬å…ˆä»å¤–éƒ¨è®¾è®¡ç³»ç»Ÿ, ç„¶åå†å®ç°å†…éƒ¨ä»£ç . ç°åœ¨æˆ‘ä»¬æ›´æœ‰æ„è¯†çš„è¿›è¡Œè¿™ä¸ªè¿‡ç¨‹.

## è‡ªå†…å‘å¤–
æˆ‘ä»¬åˆå­¦ç¼–ç¨‹çš„æ—¶å€™, æˆ–è€…å¤§å¤šæ•°æ—¶å€™éƒ½æ˜¯è¿™æ ·åšçš„. é‡åˆ°ä¸€ä¸ªé¡¹ç›®, é¦–å…ˆæƒ³çš„æ˜¯ä»æœ€å†…å±‚æœ€åº•å±‚å¼€å§‹.

æ¯”å¦‚ç°åœ¨è¿™ä¸ªä»»åŠ¡, å‡è®¾ç”¨æˆ·æœ‰ä¸€ä¸ª"æˆ‘çš„æ¸…å•åˆ—è¡¨"é¡µé¢, è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è‚¯å®šæƒ³ç»™ List æ¨¡å‹æ·»åŠ ä¸€ä¸ª owner å±æ€§, å› ä¸ºè¿™ä¸ªæ˜¯å¤ªæ˜æ˜¾éœ€è¦çš„ä¸€ä¸ªå±æ€§äº†. ç„¶åæˆ‘ä»¬å°±ä¼šä»¥è¿™ä¸ªæ¨¡å‹ä¸ºåœ†å¿ƒ, ä¸€åœˆä¸€åœˆåœ°å†™ä»£ç , å…ˆå†™æ§åˆ¶å™¨ (Django é‡Œé¢çš„ View), ç„¶åæ˜¯æ¨¡æ¿, æœ€åæ˜¯è·¯ç”±. è¿™æ ·åšçš„è¯æˆ‘ä»¬å¿ƒé‡Œæ„Ÿè§‰å¾ˆè¸å®, æˆ‘ä»¬å†™çš„æ¯ä¸€å¥ä»£ç éƒ½æ˜¯å»ºç«‹åœ¨å¦å¤–å·²ç»å®ç°çš„ä»£ç ä¹‹ä¸Šçš„.

è¿™æ ·åšæœ‰å•¥é—®é¢˜å—? å› ä¸ºä½ å’‹çŸ¥é“å¤–éƒ¨æ€ä¹ˆç”¨çš„? è™½ç„¶ä¸èƒ½è¯´æ˜¯æ‹è„‘è¢‹æƒ³çš„, ä½†æ˜¯çš„ç¡®æ˜¯"æˆ‘è®¤ä¸º"å¤–éƒ¨ä¼šè¿™ä¹ˆç”¨. è¿™æ ·çš„è¯, å¾ˆå¯èƒ½å†…éƒ¨çš„ä»£ç å®ç°å¤ªå¤šåŠŸèƒ½äº†, æˆ–è€…åŠŸèƒ½ä¸å¤Ÿç”¨, æˆ–è€…ä½ æä¾›ç»™å¤–éƒ¨çš„ API æ ¹æœ¬å°±ä¸æ–¹ä¾¿ä½¿ç”¨. 

## è‡ªå¤–å‘å†…

è‡ªå¤–å‘å†…å°±ä¸ä¼šæœ‰è¿™äº›é—®é¢˜. æˆ‘ä»¬é¦–å…ˆä½¿ç”¨äº† API, ç„¶åæ‰å®ç°å…¶å†…éƒ¨, ä¸å¤šä¹Ÿä¸å°‘, è€Œä¸”è‚¯å®šæ˜¯å¤–éƒ¨å¥½ç”¨çš„é‚£ç§. è‡³äºè¿™ä¸ª API æ€ä¹ˆå®ç°, ç”©é”…ç»™ä¸‹ä¸€ä¸ªäººå»åš. æ¯ä¸€å±‚çš„ä½ éƒ½ç”©é”…ç»™ä¸‹ä¸€å±‚ä½ , æ…¢æ…¢çš„å°±æŠŠæ‰€æœ‰ä»£ç å†™å®Œäº†.

è¿™ä¸ªå…¶å®å®ç°äº†ä¾èµ–åè½¬çš„è¦æ±‚.

### ä¾èµ–ç¿»è½¬:

åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹é¢†åŸŸä¸­ï¼Œ**ä¾èµ–åè½¬åŸåˆ™**ï¼ˆDependency inversion principleï¼ŒDIPï¼‰æ˜¯æŒ‡ä¸€ç§ç‰¹å®šçš„è§£è€¦ï¼ˆä¼ ç»Ÿçš„ä¾èµ–å…³ç³»åˆ›å»ºåœ¨é«˜å±‚æ¬¡ä¸Šï¼Œè€Œå…·ä½“çš„ç­–ç•¥è®¾ç½®åˆ™åº”ç”¨åœ¨ä½å±‚æ¬¡çš„æ¨¡å—ä¸Šï¼‰å½¢å¼ï¼Œä½¿å¾—é«˜å±‚æ¬¡çš„æ¨¡å—ä¸ä¾èµ–äºä½å±‚æ¬¡çš„æ¨¡å—çš„å®ç°ç»†èŠ‚ï¼Œä¾èµ–å…³ç³»è¢«é¢ å€’ï¼ˆåè½¬ï¼‰ï¼Œä»è€Œä½¿å¾—ä½å±‚æ¬¡æ¨¡å—ä¾èµ–äºé«˜å±‚æ¬¡æ¨¡å—çš„éœ€æ±‚æŠ½è±¡ã€‚

è¯¥åŸåˆ™è§„å®šï¼š

* é«˜å±‚æ¬¡çš„æ¨¡å—ä¸åº”è¯¥ä¾èµ–äºä½å±‚æ¬¡çš„æ¨¡å—ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–äºæŠ½è±¡æ¥å£ã€‚
* æŠ½è±¡æ¥å£ä¸åº”è¯¥ä¾èµ–äºå…·ä½“å®ç°ã€‚è€Œå…·ä½“å®ç°åˆ™åº”è¯¥ä¾èµ–äºæŠ½è±¡æ¥å£ã€‚

è¯¥åŸåˆ™é¢ å€’äº†ä¸€éƒ¨åˆ†äººå¯¹äºé¢å‘å¯¹è±¡è®¾è®¡çš„è®¤è¯†æ–¹å¼ã€‚å¦‚é«˜å±‚æ¬¡å’Œä½å±‚æ¬¡å¯¹è±¡éƒ½åº”è¯¥ä¾èµ–äºç›¸åŒçš„æŠ½è±¡æ¥å£ã€‚

ä½¿ç”¨ä¾èµ–ç¿»è½¬:

* Controller ä¸å†å—é™äºå¿…é¡»ä½¿ç”¨æŸä¸ª model, å¯ä»¥ä½¿ç”¨ä»»ä½•å¯ä»¥ç»™å®ƒæä¾›æ•°æ®çš„ç±»
* åœ¨ä¸éœ€è¦ä»»ä½•æ”¹å˜çš„æƒ…å†µä¸‹, å°±å¯ä»¥ä½¿ç”¨å…¶ä»–æ•°æ®æä¾›ç±»
* æ¯”å¦‚æ–°çš„ model å¯èƒ½é€šè¿‡ç½‘ç»œè¿æ¥è·å–æ•°æ® 

> çˆ¸çˆ¸è¦å•¥, å„¿å­å°±ç»™å•¥

ä»¥å‰å¯èƒ½è¿™æ ·:

![](images/13/tradition.png)

ç°åœ¨æ˜¯è¿™æ ·äº†:

![](images/13/inverse.pngs)

## åŠŸèƒ½æµ‹è¯•å¼€å§‹ä¸€æ¬¡æµç¨‹

æˆ‘ä»¬ç°åœ¨è¦æ·»åŠ ä¸€ä¸ªæ˜¾ç¤ºæˆ‘çš„æ‰€æœ‰è®¡åˆ’çš„é¡µé¢, è€Œä¸”åœ¨å¯¼èˆªæ æ”¾ç½®è¿™ä¸ªé¡µé¢çš„é“¾æ¥:

```python
import pytest

from .utils.helpers import (UserMixin, input_box_input_and_enter, 
                                    assert_table_row_text_include, 
                                    assert_inputbox_is_centered)


class TestMyList(UserMixin):
    @pytest.fixture(autouse=True)
    def browser(self, browser):
        self.browser = browser
        return browser

    def test_logged_in_users_lists_are_saved_as_my_lists(self, browser, live_server, user, password):
        self.live_server = live_server

        # ç™»å½•ç”¨æˆ·
        self.login(user, password)

        # è¾“å…¥ä¸¤ä¸ªä»»åŠ¡
        item1 = 'my first'
        item2 = 'my secode'
        input_box_input_and_enter(item1, browser)
        input_box_input_and_enter(item2, browser)
        # è®°å½•ä¸‹å½“å‰çš„ç½‘å€
        first_list_url = browser.current_url

        # å‘ç°æœ‰ä¸€ä¸ªæˆ‘çš„åˆ—è¡¨çš„é“¾æ¥, å¹¶ç‚¹å‡»
        browser.find_element_by_id('my_list').click()

        # å‘ç°ä¹‹å‰æ·»åŠ çš„ä»»åŠ¡åˆ—è¡¨åœ¨é‚£é‡Œ, è€Œä¸”æ ¹æ®ç¬¬ä¸€ä¸ªé¡¹ç›®å‘½å
        first_list = self.browser.find_element_by_link_text(item1)

        # è¿›å…¥äº†æˆ‘çš„æ‰€æœ‰åˆ—è¡¨é¡µé¢
        assert browser.current_url == live_server.url + '/lists/'

        # ç‚¹å‡»è¿™å’Œä¸ªä»»åŠ¡é“¾æ¥
        first_list.click()

        # å¯ä»¥å‘ç°åˆå›åˆ°äº†è¿™ä¸ªä»»åŠ¡çš„é¡¹ç›®é¡µé¢
        # assert browser.current_url == first_list_url

        # æ–°å»ºå¦ä¸€ä¸ªåˆ—è¡¨
        browser.get(live_server.url)
        item3 = 'my third'
        input_box_input_and_enter(item3, browser)
        second_list_url = browser.current_url

        # å†æ¬¡åˆ°æˆ‘çš„åˆ—è¡¨é“¾æ¥
        browser.find_element_by_id('my_list').click()
        third_link = browser.find_element_by_link_text(item3)

        # è¿›å…¥è¿™ä¸ªåˆ—è¡¨, url å°±æ˜¯åŸæ¥é‚£ä¸ª
        third_link.click()
        assert browser.current_url == second_list_url

        # é€€å‡º, çœ‹ä¸åˆ°æˆ‘çš„è®¡åˆ’äº†
        browser.find_element_by_id('logout').click()
        texts = browser.page_source
        assert 'ä¸»é¡µ' in texts
        assert 'æ³¨å†Œ' in texts
        assert 'ç™»å½•' in texts
        assert 'é€€å‡º' not in texts
        assert 'æˆ‘çš„è®¡åˆ’' not in texts
```

è¿è¡Œè¿™ä¸ªæµ‹è¯•, æŠ¥é”™:

```bash
TestMyList.test_logged_in_users_lists_are_saved_as_my_lists _____
functional_tests/my_lists_test.py:29: in test_logged_in_users_lists_are_saved_as_my_lists
    browser.find_element_by_id('my_list').click()
...
E   selenium.common.exceptions.NoSuchElementException: Message: no such element: Unable to locate element: {"method":"css selector","selector":"[id="my_list"]"}
```

### æœ€å¤–å±‚ -- æ¨¡æ¿
æµ‹è¯•è¯´æ‰¾ä¸åˆ°è¿™å’Œä¸ªå…ƒç´ , é‚£æˆ‘å°±åœ¨æ¨¡æ¿åŠ ä¸Šè¿™ä¸ªå…ƒç´ 

lists/base.html
```html
...
<body>
<nav class="navbar navbar-expand-sm navbar-light bg-light">
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a class="navbar-brand" href="{% url 'lists:home' %}">ä»Šæ—¥æ¸…å•</a>

  <div class="">
      {% if user.is_authenticated %}
        {{ user.username}}, ä½ å¥½!
        <a class="nav-item" href="{% url 'logout' %}" id="logout">é€€å‡º</a>
      {% else %}
        <a class="nav-item" href="{% url 'accounts:signup' %}" id="signup">æ³¨å†Œ</a>
        <a class="nav-item" href="{% url 'login' %}" id="login">ç™»å½•</a>
      {% endif %} 
  </div>

  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item active">
        <a class="nav-link" href="{% url 'lists:home' %}">ä¸»é¡µ</a>
      </li>
      {% if user.is_authenticated %}
      <li class="nav-item">
        <a class="nav-link" href="#" id="my_list">æˆ‘çš„è®¡åˆ’</a>
      </li>
      {% endif %}
    </ul>
  </div>
</nav>
...
```

æˆ‘ä»¬æ·»åŠ çš„è¿™ä¸ªé“¾æ¥é‚£ä¹Ÿå»ä¸äº†, æ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°çš„æŠ¥é”™:

```bash
TestMyList.test_logged_in_users_lists_are_saved_as_my_lists _____
functional_tests/my_lists_test.py:32: in test_logged_in_users_lists_are_saved_as_my_lists
    assert browser.current_url == live_server.url + '/lists/'
E   AssertionError: assert 'http://local...ists/1/items/' == 'http://local...:53306/lists/'
E     - http://localhost:53306/lists/
E     + http://localhost:53306/lists/1/items/
E     ?                              ++++++++
```

é‚£æˆ‘ä»¬å°±è®©ä»–å»é‚£é‡Œ:

```html
{% if user.is_authenticated %}
<li class="nav-item">
<a class="nav-link" href="{% url 'lists:lists' user.username %}" id="my_list">æˆ‘çš„è®¡åˆ’</a>
</li>
{% endif %}
```

åˆæŠ¥é”™:

```python
E   selenium.common.exceptions.NoSuchElementException: Message: no such element: Unable to locate element: {"method":"link text","selector":"my first"}
```

æ¨¡æ¿æœ‰é—®é¢˜, åŸå› æ˜¯æˆ‘ä»¬æ ¹æœ¬æ²¡æœ‰è¿™ä¸ªæ¨¡æ¿, æ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ è¿™ä¸ªæ¨¡æ¿, è¦å¼€å§‹å†™ä»£ç äº†.

### å‘ä¸‹ä¸€å±‚åˆ° View (æ§åˆ¶å™¨)
æ—¢ç„¶è¦å†™ä»£ç , æŒ‰ç…§ TDD è¦æ±‚, å…ˆå†™å•å…ƒæµ‹è¯•, è¦æ±‚æˆ‘ä»¬ä½¿ç”¨æ­£ç¡®çš„æ¨¡æ¿:

lists/view_test.py

```python
def test_my_lists_url_should_render_my_list_template(self, client):
    response = client.get(reverse('lists:my_lists', kwargs={'user': 'a@a.com'}))
    assertTemplateUsed(response, 'lists/my_lists.html')
```

æŠ¥é”™:
```bash
E   django.urls.exceptions.NoReverseMatch: Reverse for 'my_lists' not found. 'my_lists' is not a valid view function or pattern name.
```

è¿™å‘Šè¯‰æˆ‘ä»¬éœ€è¦ä¿®æ”¹ urls.py

```python
from .views import home_page, lists, items, my_lists

app_name = 'lists'
urlpatterns = [
    path('', home_page, name='home'),
    path('lists/<int:id>/items/', items, name='items'), # post for create new item
    path('lists/', lists, name='lists'),  # get for all list, post for create new list
    path('lists/<user>/', my_lists, name='my_lists'), 
]
```

å¯¹åº”çš„ views.py
```python
def my_lists(request, user):
    return render(request, 'lists/my_lists.html')
```

å¯¹åº”çš„æ¨¡æ¿:

```html
{% extends 'lists/base.html' %}

{% block header_text %}æˆ‘çš„è®¡åˆ’{% endblock header_text %}
```

å•å…ƒæµ‹è¯•é€šè¿‡. ä¸è¿‡è¿™ä¸ªæ—¶å€™åŠŸèƒ½æµ‹è¯•è¿˜æ˜¯åŒæ ·æŠ¥é”™

## å†æ¬¡è‡ªå¤–å‘å†…

### è®¾è®¡ API

ä¿®æ”¹ base.html

```html
<div class="container">

    {% block content %}
    {% endblock content %}

    <div class="row">
        <div class="col-md-6 offset-md-3">
            {% block table %}
            {% endblock %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 offset-md-3">
            {% block extra_content %}
            {% endblock %}
        </div>
    </div>
```

my_lists.html
```html
{% extends 'lists/base.html' %}

{% block header_text %}æˆ‘çš„è®¡åˆ’{% endblock header_text %}

{% block content %}
<h1 class="text-center">æˆ‘çš„è®¡åˆ’</h1>
{% endblock content %}

{% block extra_content %}
<h2>{{ user.username }}çš„è®¡åˆ’</h2>   <!-- ğŸ¶ -->
<ul>
    {% for list in user.list_set.all %}  <!--  ğŸˆ-->
        <li><a href="{{ list.get_absolute_url }}">{{ list.name }}</a></li>  <!-- ğŸ“-->
    {% endfor %}
</ul>
{% endblock extra_content %}
```
* ğŸ¶ æˆ‘ä»¬æƒ³è¦ä¸€ä¸ªå«åš `user` çš„å˜é‡ç”¨æ¥ä»£è¡¨æ¨¡æ¿ä¸­çš„ç”¨æˆ·
* ğŸˆ æˆ‘ä»¬æƒ³è¦éå†æŸä¸ªç”¨æˆ·çš„æ‰€æœ‰è®¡åˆ’åˆ—è¡¨
* ğŸ“ æˆ‘ä»¬å¸Œæœ›ä½¿ç”¨ `list.name` æ¥æ˜¾ç¤º

ç°åœ¨è¿è¡ŒåŠŸèƒ½æµ‹è¯•, è¿˜æ˜¯åŒæ ·æŠ¥é”™

### å†ä¸‹ä¸€å±‚ -- åˆ°åº•è¦æ˜¾ç¤ºå•¥
æˆ‘ä»¬éœ€è¦å‘Šè¯‰æ¨¡æ¿æ˜¾ç¤ºçš„å…·ä½“å†…å®¹, æœ€é‡è¦çš„æ˜¯ç”¨æˆ·æ˜¯è°

```python
def test_my_list_should_pass_correct_user_to_template(self, client):
    correct_user = Account.objects.create(username='john', email='a@a.com', password='Storng1234')
    wrong_user = Account.objects.create(username='wrong', email='wribg@a.com', password='Storng1234')

    response = client.get(reverse('lists:my_lists', kwargs={'user': correct_user.username}))
    assert response.context['user'] == correct_use
```

æŠ¥é”™:
```bash
TestListView.test_my_list_should_pass_correct_user_to_template ______
lists/tests/view_test.py:195: in test_my_list_should_pass_correct_user_to_template
    assert response.context['user'] == correct_user
E   assert <SimpleLazyObject: <django.contrib.auth.models.AnonymousUser object at 0x7f9f32a29898>> == <Account: john>
```

æ‰€ä»¥ä¿®æ”¹ views.py

```python
def my_lists(request, user):
    user = Account.objects.get(username=user)
    return render(request, 'lists/my_lists.html', {'user': user})
```

è¿™ä¸ªæµ‹è¯•è¿‡äº†, ä¸Šä¸ªæµ‹è¯•æŒ‚äº†, æ”¹ä¸€ä¸‹ä¸Šä¸ªæµ‹è¯•: 

```python
def test_my_lists_url_should_render_my_list_template(self, client):
    correct_user = Account.objects.create_user(username='john', email='a@a.com', password='Storng1234')
    response = client.get(reverse('lists:my_lists', kwargs={'user': 'john'}))
    assertTemplateUsed(response, 'lists/my_lists.html')
```

è¿è¡ŒåŠŸèƒ½æµ‹è¯•, æŠ¥é”™:

```bash
TestMyList.test_logged_in_users_lists_are_saved_as_my_lists _______
functional_tests/my_lists_test.py:32: in test_logged_in_users_lists_are_saved_as_my_lists
    first_list = self.browser.find_element_by_link_text(item1)
    ...
E   selenium.common.exceptions.NoSuchElementException: Message: no such element: Unable to locate element: {"method":"link text","selector":"my first"}
```

æ‰¾ä¸åˆ°éœ€è¦çš„å†…å®¹, è‚¯å®šæ²¡æœ‰, å› ä¸ºæˆ‘ä»¬æ²¡å†™å•Š.

views ä¸­å·²ç»æŠŠåº”è¯¥ä¼ çš„å‚æ•°éƒ½ä¼ äº†, ç°åœ¨éœ€è¦ user ä¸­æœ‰æˆ‘ä»¬éœ€è¦çš„ list ä¿¡æ¯:

```python
def test_list_user_is_save_if_user_is_authenticated(self, client):
    user = Account.objects.create_user(username='john', email='a@a.com', password='Storng1234')
    client.force_login(user)
    client.post(reverse('lists:lists'), data={'text': 'new item'})
    list_ = List.objects.first()
    assert list_.user == user
```
è¿™é‡Œçš„ `force_longin` å°±æ˜¯è®©æµ‹è¯•å®¢æˆ·ç«¯ç™»å½•ç”¨æˆ·.

æŠ¥é”™:
```bash
TestListView.test_list_user_is_save_if_user_is_authenticated _______________
lists/tests/view_test.py:203: in test_list_user_is_save_if_user_is_authenticated
    assert list_.user == user
E   AttributeError: 'List' object has no attribute 'user'
```
è¿™ä¸ªé”™è¯¯è¯´æ˜éœ€è¦ä¿®æ”¹ view ä¸º:

```python
def lists(request):
    if request.method == 'POST':
        form = ItemForm(data=request.POST)
        if form.is_valid():
            list_ = List()
            list_.user = request.user
            list_.save()
            # list_ = List.objects.create()
            # item = Item.objects.create(text=request.POST['text'], list=list_)
            form.save(for_list=list_)
            return redirect(list_)

        return render(request, 'lists/home.html', {'form': form})
```

ä¸è¿‡è¿™ä¸ªä¸å¯èƒ½é€šè¿‡, å› ä¸ºè¿™ä¸ªæ˜¾ç„¶éœ€è¦ model å®ç°äº†. æˆ‘ä»¬éœ€è¦ model è®°å½•å½“å‰åˆ—è¡¨æ˜¯å“ªä¸ªç”¨æˆ·åˆ›å»ºçš„:

```bash
TestListView.test_list_user_is_save_if_user_is_authenticated _______________
lists/tests/view_test.py:203: in test_list_user_is_save_if_user_is_authenticated
    assert list_.user == user
E   AttributeError: 'List' object has no attribute 'user'
```

æ‰€ä»¥è¿˜å¾—ä¸‹ä¸€å±‚

### æƒ³ä¸€æƒ³

ç°åœ¨æœ‰ä¸€ä¸ªå¤±è´¥æµ‹è¯•, åœ¨ä¸‹ä¸€å±‚æ„å‘³ç€ä¸€ä¸ªé—®é¢˜æ²¡è§£å†³åˆå»è§£å†³å¦ä¸€ä¸ªé—®é¢˜. å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ mock. ä½†æ˜¯ä½¿ç”¨ mock ä¹Ÿæœ‰é—®é¢˜, è¯¦è§ä¸Šä¸€ç« . æ‰€ä»¥æˆ‘è¿˜æ˜¯å€¾å‘äºèƒ½æŠŠæ¡å¾—ä½çš„è¯å°±å¤§èƒ†çš„ä¸‹ä¸€å±‚.

### å†ä¸‹ä¸€å±‚ -- æ¨¡å‹

æˆ‘ä»¬æƒ³è¦ `list` æœ‰ `user`, å½“ç„¶è¿˜è¦æœ‰ `user.list_set.all`

æ¨¡å‹æµ‹è¯•:

```python
def test_lists_should_have_user(self):
    user = Account.objects.create_user(username='john', email='a@a.com', password='Storng1234')
    list_ = List.objects.create(user=user)
    assert list_ in user.list_set.all()
```
æŠ¥é”™:
```bash
E   TypeError: List() got an unexpected keyword argument 'user'
```

å®ç° (å¯ä»¥æ²¡æœ‰ user):

```python
from django.contrib.auth import get_user_model

class List(models.Model):
    user = models.ForeignKey(get_user_model(), on_delete=models.CASCADE, blank=True, null=True)

    def get_absolute_url(self):
        return reverse("lists:items", kwargs={"id": self.id})
```

æµ‹è¯•:

```bash
TestItemAndListModel.test_item_model_should_save_post_request_from_list_page _
lists/tests/model_test.py:55: in test_item_model_should_save_post_request_from_list_page
    response = client.post('/lists/', data={'text': 'an item'})
    ...
E   ValueError: Cannot assign "<SimpleLazyObject: <django.contrib.auth.models.AnonymousUser object at 0x7f94e5fc8ba8>>": "List.user" must be a "Account" instance.
```

è¿™é‡Œè¯´æˆ‘ä»¬å°† `AnonymousUser` èµ‹å€¼ç»™äº† `user`, è¿™ä¸ªéœ€è¦æ”¹ view äº†:

```python
def lists(request):
    if request.method == 'POST':
        form = ItemForm(data=request.POST)
        if form.is_valid():
            list_ = List()
            ###############################
            if request.user.is_authenticated:
                list_.user = request.user
            ################################
            list_.save()
            form.save(for_list=list_)
            return redirect(list_)

        return render(request, 'lists/home.html', {'form': form}
```

ç°åœ¨æ‰€æœ‰æµ‹è¯•é€šè¿‡.

ä¸è¿‡åŠŸèƒ½æµ‹è¯•è¯´çš„æ˜¯æˆ‘ä»¬çœ‹ä¸åˆ° list åˆ—è¡¨, æ‰€ä»¥ç»§ç»­æ”¹.

model_test.py

```python
def test_list_name_should_be_the_first_item_text(self):
    list_ = List.objects.create()
    Item.objects.create(list=list_, text='first item')
    Item.objects.create(list=list_, text='second item')

    assert list_.name == 'first item'
```

models.py:

```python
class List(models.Model):
    user = models.ForeignKey(get_user_model(), on_delete=models.CASCADE, blank=True, null=True)

    def get_absolute_url(self):
        return reverse("lists:items", kwargs={"id": self.id})

    @property
    def name(self):
        return self.item_set.first().text
```

å…¨è¿‡äº†

## é‡æ„

```python
def lists(request):
    if request.method == 'POST':
        form = ItemForm(data=request.POST)
        if form.is_valid():
            list_ = List()
            if request.user.is_authenticated:
                list_.user = request.user
            list_.save()
            # list_ = List.objects.create()
            # item = Item.objects.create(text=request.POST['text'], list=list_)
            form.save(for_list=list_)
            return redirect(list_)

        return render(request, 'lists/home.html', {'form': form})
```

è¿™é‡Œçš„å·¥ä½œå¤ªå¤šäº†. View éœ€è¦åˆ›å»º list, éœ€è¦éªŒè¯ç”¨æˆ·, Form æ¥åšä¸å¥½å—? 

> æ§åˆ¶å™¨æœ‰å¤šå±‚ if å¾€å¾€æ˜¯æœ‰é—®é¢˜çš„

å¦‚æœèƒ½è¿™æ ·æ˜¯ä¸æ˜¯æ›´å¥½:

```python
def lists(request):
    if request.method == 'POST':
        form = NewListForm(data=request.POST)
        if form.is_valid():
            list_ = form.save(user=request.user)
            return redirect(list_)

        return render(request, 'lists/home.html', {'form': form})
```
æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªç¾å¥½çš„æ„¿æœ›, ç°åœ¨é—®é¢˜å°±æ˜¯å¦‚ä½•å®ç°äº†.

### ä»¥åˆä½œè€…çš„è§’åº¦æ€è€ƒé—®é¢˜

`view` ä¼šè°ƒç”¨å„ç§èµ„æº, ä¸è¿‡ `view` ä¸åº”è¯¥äº²è‡ªå»å¹², å®ƒåº”è¯¥æ‰¾åˆé€‚çš„åˆä½œè€…å»åš. è¿™é‡Œ, `view` çš„ä¸»è¦åˆä½œè€…æ˜¯ `form`, ä½†æ˜¯ç°åœ¨ `form` è¿˜æ²¡æœ‰æ€ä¹ˆåŠ? è¿™é‡Œæˆ‘ä»¬è¯•è¯• mock.

ä¸è¿‡å¦‚æœä¿®æ”¹ `view` ä¸­çš„ `lists` æ–¹æ³•, ä¼šå¯¼è‡´å…¶ä»–æµ‹è¯•å¤±è´¥, è¿™é‡Œæš‚æ—¶åœ¨å¦ä¸€ä¸ªæ–¹æ³• `list2` ä¸­å®ç°:

```python
class TestCreateItem:
    @pytest.fixture()
    def post_request(self):
        request = HttpRequest()
        request.POST['text'] = 'New Item'
        request.method = 'POST'
        request.user = mocker.Mock()
        return request
        ...
    def test_post_data_should_call_NewListForm(self, post_request, mocker):
        fake_form = mocker.patch('lists.views.NewListForm')
        lists2(post_request)
        fake_form.assert_called_once_with(data=post_request.POST)
```

å› ä¸ºæ ¹æœ¬æ²¡æœ‰è¿™ä¸ª form, æ‰€ä»¥æŠ¥é”™:

æŠ¥é”™:
```bash
E   AttributeError: <module 'lists.views' from '/Users/sziit/Programming/python_web/django/superlists/lists/views.py'> does not have the attribute 'NewListForm'
```

views.py:

```py
from .forms import ItemForm, UniqueItemForm, NewListForm
```

forms.py:
```py
class NewListForm(ItemForm):
    pass
```

å†æ¬¡æµ‹è¯•, æŠ¥é”™:

```python
E   AssertionError: Expected 'NewListForm' to be called once. Called 0 times.
```

ä¸é”™, å› ä¸ºæˆ‘ä»¬çœŸçš„æ²¡ç”¨è¿‡.

`View` ä¸­å®ç°:

```python
def lists2(request):
    if request.method == 'POST':
        form = NewListForm(data=request.POST)
```

æµ‹è¯•é€šè¿‡. æˆ‘ä»¬ç»§ç»­, å¦‚æœè¡¨å•å¯ä»¥äº†, ä¸‹ä¸€æ­¥æˆ‘ä»¬æƒ³ä¿å­˜è¡¨å•

```py
def test_form_save_with_valid_user_should_be_called(self, post_request, mocker):
    fake_form = mocker.patch('lists.views.NewListForm').return_value  # return value æ‰èƒ½ mock å®ƒçš„æ–¹æ³•
    fake_form.is_valid.return_value = True

    lists2(post_request)
    fake_form.save.assert_called_once_with(user=post_request.user)
```

å¯¹åº”çš„ View:

```py
def lists2(request):
    if request.method == 'POST':
        form = NewListForm(data=request.POST)
        form.save(user=request.user)
```

æ¥ç€, æˆ‘ä»¬è¿˜æƒ³å¦‚æœè¡¨å•åˆæ³•, view åº”è¯¥é‡å®šå‘åˆ°åˆ—è¡¨, æ‰€ä»¥ç»§ç»­ mock å¦ä¸€ä¸ªåˆä½œè€… redirect.

```py
def test_l1ist_page_POST_should_redirect(self, mocker, post_request):
    fake_form = mocker.patch('lists.views.NewListForm').return_value  # return value æ‰èƒ½ mock å®ƒçš„æ–¹æ³•
    fake_form.is_valid.return_value = True

    fake_redirect = mocker.patch('lists.views.redirect')

    response = lists2(post_request)

    assert response == fake_redirect.return_value
    fake_redirect.assert_called_once_with(fake_form.save.return_value)
```

```bash
assert response == fake_redirect.return_value
E   AssertionError: assert None == <MagicMock name='redirect()' id='140576152497624'>
```

æ²¡æœ‰è¿”å›å€¼, æ”¹ view:

```py
def lists2(request):
    if request.method == 'POST':
        form = NewListForm(data=request.POST)
        list_ = form.save(user=request.user)
        return redirect(list_)
```

æ”¹å®Œä¹‹å, åˆšæ‰å…¶ä»–ä¸¤ä¸ªæµ‹è¯•å¤±è´¥äº†, å› ä¸ºæˆ‘ä»¬ç”¨äº†ç³»ç»Ÿçš„ `redirect`, éƒ½ mock æ‰.

```py
def test_post_data_should_call_NewListForm(self, post_request, mocker):
    fake_form = mocker.patch('lists.views.NewListForm')
    mocker.patch('lists.views.redirect')

    lists2(post_request)

    fake_form.assert_called_once_with(data=post_request.POST)

def test_form_save_with_valid_user_should_be_called(self, post_request, mocker):
    fake_form = mocker.patch('lists.views.NewListForm').return_value  # return value æ‰èƒ½ mock å®ƒçš„æ–¹æ³•
    fake_form.is_valid.return_value = True

    mocker.patch('lists.views.redirect')

    lists2(post_request)
    fake_form.save.assert_called_once_with(user=post_request.user)
```

### è¡¨å•ä¸åˆæ³•çš„æƒ…å†µ

å¦‚æœè¡¨å•ä¸åˆæ³•, æˆ‘ä»¬æ¸²æŸ“ä¸»é¡µ:

æµ‹è¯•

```py
def test_invalid_form_should_render_home(self, mocker, post_request):
    fake_form = mocker.patch('lists.views.NewListForm').return_value  # return value æ‰èƒ½ mock å®ƒçš„æ–¹æ³•
    fake_form.is_valid.return_value = False
    
    fake_render = mocker.patch('lists.views.render')

    response = lists2(post_request)

    assert response == fake_render.return_value
    fake_render.assert_called_once_with(post_request, 'lists/home.html', {'form': fake_form})
```

ä»£ç :

```python
def lists2(request):
    if request.method == 'POST':
        form = NewListForm(data=request.POST)
        list_ = form.save(user=request.user)
        if form.is_valid():
            return redirect(list_)

        return render(request, 'lists/home.html', {'form': form})
```

ä¸è¿‡å¦‚æœä¸åˆæ³•, è¡¨å•ä¸åº”è¯¥ä¿å­˜å§, æµ‹è¯•:
```python
def test_invalid_form_should_not_save(self, mocker, post_request):
    fake_form = mocker.patch('lists.views.NewListForm').return_value  # return value æ‰èƒ½ mock å®ƒçš„æ–¹æ³•
    fake_form.is_valid.return_value = False
    
    lists2(post_request)

    assert fake_form.save.called == False
```
å‘ç°ä»£ç æœ‰é—®é¢˜, æ”¹ä»£ç :

```python
def lists2(request):
    if request.method == 'POST':
        form = NewListForm(data=request.POST)
        if form.is_valid():
            list_ = form.save(user=request.user)
            return redirect(list_)
            ...
```

ç°åœ¨ view æå®šäº†, ç»§ç»­ form å±‚

### form å±‚

æˆ‘ä»¬å·²ç»å¤§é‡ "ä½¿ç”¨äº†" NewListForm, ä½†æ˜¯å®é™…ä¸Šæ²¡æœ‰å†™å•¥ä»£ç , ä¸è¿‡æˆ‘ä»¬å¸Œæœ›å®ƒçš„ save æ–¹æ³•èƒ½:
* åˆ›å»ºæ–°çš„ list, å¹¶ç»™å…¶è®¾å®š user
* åˆ›å»ºæ–°çš„ item, å¹¶ç»™å…¶è®¾å®š list
* ä¿å­˜ item

ä¸è¿‡ form ä»£ç çš„ä»»åŠ¡å¤ªå¤šäº†, æˆ‘ä»¬æƒ³ç”¨ä¸€å¥è¯è§£å†³ä¸Šè¿°ä»»åŠ¡æ€ä¹ˆåŠ? ç”©é”…ç»™ model!

æˆ‘ä»¬æƒ³ save å¤§æ¦‚è¿™ä¹ˆæ ·:
```py
def save(self):
    List.create_new(first_item_text = some_text, user=user)
```

æµ‹è¯•:
```py
@pytest.mark.django_db
class TestNewListFormTest:
    def test_anomynouse_user_save_method_should_create_new_list(self, mocker):
        user = mocker.Mock(is_authenticated=False)
        list_count = List.objects.count()
        form = NewListForm(data={'text': 'new item'})
        form.is_valid()  # è¿™æ ·æ‰å¯ä»¥ä½¿ç”¨ cleaned_data
        form.save(user=user)

        assert List.objects.count() == list_count + 1

    def test_authenticated_user_save_method_should_create_new_list(self, mocker):
        user = Account.objects.create_user(username='john', email='a@a.com', password='Storng1234')
        list_count = List.objects.count()
        form = NewListForm(data={'text': 'new item'})
        form.is_valid()
        form.save(user=user)

        assert List.objects.count() == list_count + 1
```


forms.py:

```python
class NewListForm(ItemForm):

    def save(self, user):
        if user.is_authenticated:
            return List.create_new(first_item_text=self.cleaned_data['text'], user=user)
        else:
            return List.create_new(first_item_text=self.cleaned_data['text'])
```

model:

```py
class List(models.Model):
    user = models.ForeignKey(get_user_model(), on_delete=models.CASCADE, blank=True, null=True)

    def get_absolute_url(self):
        return reverse("lists:items", kwargs={"id": self.id})

    @staticmethod
    def create_new(first_item_text, user=None):
        list_ = List.objects.create(user=user)
        Item.objects.create(text=first_item_text, list=list_)
        return list_

    @property
    def name(self):
        return self.item_set.first().text
```

è¿™æ—¶, æ‰€æœ‰æµ‹è¯•é€šè¿‡.

ä¸ºäº†ç”¨æ–°çš„ä»£ç , æˆ‘ä»¬æ”¹å˜è·¯ç”±è®¾ç½®:

```py
urlpatterns = [
    path('', home_page, name='home'),
    path('lists/<int:id>/items/', items, name='items'), # post for create new item
    path('lists/', lists2, name='lists'),  # get for all list, post for create new list
    path('lists/<user>/', my_lists, name='my_lists'), 
]
```









å‚è€ƒ:
* [Outside-In or Inside-Out? London or Chicago School? â€” Part 1: Greenfield Projects](https://itnext.io/outside-in-or-inside-out-london-or-chicago-school-part-1-greenfield-projects-d324390a0dbd)
* [Outside-In or Inside-Out? â€” Part 2: Refactoring Existing Projects](https://itnext.io/outside-in-or-inside-out-part-2-refactoring-existing-projects-dcf7f2ef4d2a)
* [TDD - Outside In vs Inside Out](https://softwareengineering.stackexchange.com/questions/166409/tdd-outside-in-vs-inside-out)