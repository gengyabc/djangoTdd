# æµ‹è¯•å„ç§æƒ…å†µ

## model æµ‹è¯•

é¦–å…ˆæ¥çœ‹ model, è¿™é‡ŒçœŸæ­£åœ°å¯ä»¥åšåˆ°:

* æ¯”å¦‚æœ‰: ç”¨æˆ·å,é‚®ç®±,å¯†ç , å…¶ä»–å¯æœ‰å¯æ— 
* ç”¨æˆ·åä¸è¦å¤ªé•¿, <= 150
* é‚®ç®±å¿…é¡»æä¾›, è€Œä¸”çœŸçš„æ˜¯é‚®ç®±æ‰è¡Œ
* å¹´é¾„å¯æœ‰å¯æ— , ä½†æ˜¯å¡«çš„ä¸èƒ½æ˜¯è´Ÿæ•°
* å¯†ç è¦æœ‰é€‚å½“çš„å¼ºåº¦

ä¸‹é¢å°±å†™è¿™äº›æµ‹è¯•

> Django [ä¸ä¼šä¸»åŠ¨éªŒè¯ model](https://stackoverflow.com/questions/40881708/django-model-validator-not-working-on-create), åªä¼šåœ¨ [form ä¸»åŠ¨éªŒè¯](https://docs.djangoproject.com/en/3.0/ref/validators/), æ‰€ä»¥ `objects.create()` ä¸åšéªŒè¯, [å‚è€ƒ](https://dev.to/foadmoha/validating-django-models-that-are-created-without-forms-29gp)

```python
import pytest
from django.contrib.auth.hashers import check_password
from django.core.exceptions import ValidationError
from django.db.utils import IntegrityError

from ..models import Account


@pytest.mark.django_db
class TestAccountModel:
    @pytest.fixture()
    def legal_username_password_email(self):
        return 'aaa', 'IamStrong7352', 'user@user.com'

    def test_create_account_should_basically_right(self, legal_username_password_email):
        username, password, email = legal_username_password_email
        Account.objects.create_user(username=username, password=password, email=email)
        # account = Account(username='aaa', password=password)
        # account.full_clean()

        # account = Account.objects.get(username=username)
        account = Account.objects.first()

        assert account.username == username
        assert account.is_active == True
        assert account.is_staff == False
        assert account.is_superuser == False

        assert account.email == email
        assert check_password(password, account.password)

    def test_create_account_should_set_right_age(self, legal_username_password_email):
        username, password, email = legal_username_password_email
        account = Account(username=username, password=password, email=email)

        account.full_clean()
        account.save()

        assert account.age is None

        account.age = 10
        account.save()

        saved_account = Account.objects.first()
        assert saved_account.age == 10

    def test_create_account_must_have_username(self, legal_username_password_email):
        username, password, email = legal_username_password_email

        account = Account(password=password, email=email)
        with pytest.raises(ValidationError):
            account.full_clean()

    def test_create_account_must_have_password(self, legal_username_password_email):
        username, password, email = legal_username_password_email

        account = Account(username=username, email=email)
        with pytest.raises(ValidationError):
            account.full_clean()
        

    def test_create_account_must_have_email(self, legal_username_password_email):
        username, password, email = legal_username_password_email

        account = Account(password=password, username=username)
        with pytest.raises(ValidationError):
            account.full_clean()

    @pytest.mark.parametrize('username',['a', 'a'*50, 'a'*100, 'a'*150])
    def test_username_length_should_between_1_and_150(self, legal_username_password_email, username):
        _, password, email = legal_username_password_email

        account = Account(username=username, email=email, password=password)
        account.full_clean()

    @pytest.mark.parametrize('username',['a'*151, 'a'*1000])
    def test_username_length_larger_than_150_should_raise_error(self, legal_username_password_email, username):
        _, password, email = legal_username_password_email

        account = Account(username=username, email=email, password=password)
        with pytest.raises(ValidationError):
            account.full_clean()

    @pytest.mark.parametrize('email',['a', 'asgsg','a@a','1@1.1', '@abc.com'])
    def test_username_length_larger_than_150_should_raise_error(self, legal_username_password_email, email):
        username, password, _ = legal_username_password_email

        account = Account(username=username, email=email, password=password)
        with pytest.raises(ValidationError):
            account.full_clean()

    @pytest.mark.parametrize('age',[0, 1, 100])
    def test_age_should_be_non_negative(self, legal_username_password_email, age):
        username, password, email = legal_username_password_email

        account = Account(username=username, email=email, password=password, age=age)
        account.full_clean()

    @pytest.mark.parametrize('age',[-1, -1.1, -100])
    def test_negative_age_should_raise_error(self, legal_username_password_email, age):
        username, password, email = legal_username_password_email

        with pytest.raises(IntegrityError):
            Account.objects.create_user(username=username, email=email, password=password, age=age)

    @pytest.mark.parametrize('age',[-0.1, -0.5, -0.9])
    def test_age_between_0_and_minus1_should_be_changed_to_0(self, legal_username_password_email, age):
        username, password, email = legal_username_password_email

        Account.objects.create_user(username=username, email=email, password=password, age=age)

        account = Account.objects.first()
        assert account.age == 0
        
    @pytest.mark.parametrize('age',[-0.1, -0.5, -0.9])
    def test_age_between_0_and_minus1_should_be_changed_to_0(self, legal_username_password_email, age):
        username, password, email = legal_username_password_email

        Account.objects.create_user(username=username, email=email, password=password, age=age)

        account = Account.objects.first()
        assert account.age == 0
```

å¯†ç ä¸åœ¨ model æµ‹è¯•é‡Œé¢, å› ä¸ºå¯†ç å¼ºåº¦ç­‰æ˜¯åœ¨ form å±‚éªŒè¯çš„.


## è¡¨å•æµ‹è¯•

```python
from ..forms import AccountCreationForm, AccountChangeForm

@pytest.mark.django_db
class TestAccountCreationForm():
    @pytest.fixture()
    def data(self):
        return 'aaa', 'a@a.com', 10, 'IamStrong321', 'IamStrong321'
    

    def test_AccountCreationFrom_normal_input_should_be_valid(self, data):
        username, email, age, password1,password2 = data
        form = AccountCreationForm(data={
            'username': username,
            'email': email,
            'age': age,
            'password1': password1,
            'password2': password2})

        assert form.is_valid() == True



    def test_empty_AccountCreationForm_should_be_invalid(self):
        form = AccountCreationForm()
        assert form.is_valid() == False
        with pytest.raises(AttributeError):
            form.save()

    def test_empty_username_should_be_invalid(self, data):
        _, email, age, password1,password2 = data
        form = AccountCreationForm(data={
            'username': '',
            'email': email,
            'age': age,
            'password1': password1,
            'password2': password2})
        assert form.is_valid() == False
        with pytest.raises(ValueError):
            form.save()

    def test_empty_email_should_be_invalid(self, data):
        username, _, age, password1,password2 = data
        form = AccountCreationForm(data={
            'username': username,
            'email': '',
            'age': age,
            'password1': password1,
            'password2': password2})
        assert form.is_valid() == False
        with pytest.raises(ValueError):
            form.save()
```

æ›´å¤šéæ³•æµ‹è¯•è¿™é‡Œä¸åšäº†, å¤ªéº»çƒ¦äº†

## view æµ‹è¯•

æ‡’å¾—å†™äº†. æˆ‘ä»¬è‡ªå·±å†™çš„åŠŸèƒ½ä¹Ÿä¸å¤š, ä¸»è¦å°±æ˜¯è®¾ç½®äº†è·³è½¬ç­‰, è‡ªå·±è¯•è¯•æµ‹è¯•

> ä¿®æ”¹æ¨¡æ¿åŠå¼•ç”¨, ç›´æ¥çœ‹æºç å§.

## å¯†ç ä¿®æ”¹ä¸é‡ç½®

django å·²ç»æœ‰äº†æ‰€æœ‰åŠŸèƒ½, å…·ä½“æ¥è¯´:

```bash
admin/
[name='home']
lists/<int:id>/items/ [name='items']
lists/ [name='lists']
accounts/ signup/ [name='signup']
accounts/ login/ [name='login']
accounts/ logout/ [name='logout']
accounts/ password_change/ [name='password_change']
accounts/ password_change/done/ [name='password_change_done']
accounts/ password_reset/ [name='password_reset']
accounts/ password_reset/done/ [name='password_reset_done']
accounts/ reset/<uidb64>/<token>/ [name='password_reset_confirm']
accounts/ reset/done/ [name='password_reset_complete']
```

è‡ªå·±è¾“å…¥ç½‘å€å»æ‰¾åŠŸèƒ½å°±è¡Œäº†.

### ä¿®æ”¹ä¿®æ”¹

è¿™é‡Œéƒ½æ˜¯ä¿®æ”¹æ¨¡æ¿, ä¸å¯¹åå°åŠŸèƒ½åšä¿®æ”¹, åšåŠŸèƒ½æµ‹è¯•å³å¯. ä¸è¿‡å¾—ç°æœ‰ç”¨æˆ·ç™»å½•æ‰å¯ä»¥,  


conftest.py:
```python
import pytest
from selenium import webdriver

import sys
sys.path.append("/Users/sziit/Programming/python_web/django/superlists/accounts")  # å¦åˆ™æ— æ³•å¼•ç”¨
from accounts.models import Account


...

@pytest.fixture()
def password():
    return 'StrongPass123'

@pytest.fixture()
def user(password):
    return Account.objects.create_user(username='aaa', email='ww@a.com', password=password)
```

ç„¶å helpers.py:
```python
def login(browser, live_server, user, password):
    # ä»–æ‰“å¼€ç½‘ç«™çš„ä¸»é¡µ
    browser.get(live_server.url + '/accounts/login')

    browser.find_element_by_id('id_username').send_keys(user.username)
    browser.find_element_by_id('id_password').send_keys(password)
    browser.find_element_by_xpath('/html/body/div/form/button').click()
```

æœ€åå°±æ˜¯åŠŸèƒ½æµ‹è¯•ä»£ç :

```python
import pytest
import time

from .utils.helpers import login


def test_password_change(browser, live_server, user, password):

    # ç™»å½•ç”¨æˆ·
    login(browser, live_server, user, password)

    # ä¿®æ”¹å¯†ç 
    browser.get(live_server.url + '/accounts/password_change')
    time.sleep(5)

    new_password = 'anotherStrong123'

    browser.find_element_by_id('id_old_password').send_keys(password)
    browser.find_element_by_id('id_new_password1').send_keys(new_password)
    browser.find_element_by_id('id_new_password2').send_keys(new_password)
    browser.find_element_by_xpath('/html/body/div/form/button').click()
    time.sleep(0.5)

    # é€€å‡ºç™»å½•
    browser.find_element_by_id('logout').click()

    # ç™»å½•
    browser.find_element_by_id('login').click()
    browser.find_element_by_id('id_username').send_keys(user.username)
    browser.find_element_by_id('id_password').send_keys(new_password)
    browser.find_element_by_xpath('/html/body/div/form/button').click()

    # ç¡®å®šç™»å½•äº†
    links = browser.find_elements_by_css_selector('li>a.nav-link')
    texts = [link.text for link in links]
    assert 'é€€å‡º' in texts
```

ä¸è¿‡è¿™ä¸ªå†™çš„å¤ªéº»çƒ¦, é‡æ„ä¸€ä¸‹:

helper.py:
```python
from selenium.webdriver.common.keys import Keys
import pytest

...
class UserMixin:
    def login(self, user, password):
        # ä»–æ‰“å¼€ç½‘ç«™çš„ä¸»é¡µ
        self.browser.get(self.live_server.url + '/accounts/login')

        self.browser.find_element_by_id('id_username').send_keys(user.username)
        self.browser.find_element_by_id('id_password').send_keys(password)
        self.browser.find_element_by_xpath('/html/body/div/form/button').click()
```

æµ‹è¯•æ–‡ä»¶:
```python
from superlists.functional_tests.conftest import password
import pytest
import time

from .utils.helpers import UserMixin

class TestPasswordChangeReset(UserMixin):

    @pytest.fixture(autouse=True)
    def browser(self, browser):
        self.browser = browser

    def test_password_change(self, live_server, user, password):
        self.live_server = live_server

        # ç™»å½•ç”¨æˆ·
        self.login(user, password)

        # ä¿®æ”¹å¯†ç 
        self.browser.get(self.live_server.url + '/accounts/password_change')
        time.sleep(5)

        new_password = 'anotherStrong123'

        self.browser.find_element_by_id('id_old_password').send_keys(password)
        self.browser.find_element_by_id('id_new_password1').send_keys(new_password)
        self.browser.find_element_by_id('id_new_password2').send_keys(new_password)
        self.browser.find_element_by_xpath('/html/body/div/form/button').click()
        time.sleep(0.5)

        # é€€å‡ºç™»å½•
        self.browser.find_element_by_id('logout').click()

        # ç™»å½•
        self.browser.find_element_by_id('login').click()
        self.browser.find_element_by_id('id_username').send_keys(user.username)
        self.browser.find_element_by_id('id_password').send_keys(new_password)
        self.browser.find_element_by_xpath('/html/body/div/form/button').click()

        # ç¡®å®šç™»å½•äº†
        links = self.browser.find_elements_by_css_selector('li>a.nav-link')
        texts = [link.text for link in links]
        assert 'é€€å‡º' in texts
```


æ‰€æœ‰è¿™äº›åŠŸèƒ½,å…¶å® Django å†…ç½®, http://127.0.0.1:8000/accounts/password_change/ å³å¯.

ä¸è¿‡è¿™ä¸ªç•Œé¢ä¸å¤ªå¯èƒ½ä¸æˆ‘ä»¬è‡ªå·±çš„éœ€æ±‚ç¬¦åˆ,æ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹å®ƒ.

 templates/registration/password_change_form.html:
 ```html
 {% extends 'lists/base.html' %}

{% block title %}ä¿®æ”¹å¯†ç {% endblock title %}

{% block content %}
    <h1>ä¿®æ”¹å¯†ç </h1>
    <form action="" method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button class="btn btn-success" type="submit">ä¿®æ”¹å¯†ç </button>
    </form>
{% endblock content %}
 ```

 templates/registration/password_change_done.html:
 ```html
 {% extends 'list/base.html' %}

{% block content %}
<h2>Password changed</h2>

<a href="{% url 'lists:home' %}">å›åˆ°ä¸»é¡µ</a>
{% endblock %}
 ```

 è¿™æ ·å°±å¯ä»¥é‡å†™å†…ç½®çš„æ¨¡æ¿äº†.

 ä¸è¿‡è¿™é‡Œæ³¨æ„, settings.py è®¾ç½®:

 ```python
 INSTALLED_APPS = [
    'accounts.apps.AccountsConfig',  # æå‰
    
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',

    'lists.apps.ListsConfig',
]
 ```


> é‡åˆ°é—®é¢˜? [è§£å†³](https://stackoverflow.com/questions/51859954/how-to-override-my-template-instead-of-django-admin-panel-for-reset-password)


### å¯†ç é‡ç½®

django å†…ç½®äº†é‡ç½®å¯†ç çš„åŠŸèƒ½, æˆ‘ä»¬éœ€è¦è‡ªå·±åšçš„æ€ä¹ˆå°±æ˜¯å‘é‚®ä»¶, æˆ–è€…è¯´æ€ä¹ˆå‘é€å¯†ç .

ä½¿ç”¨è…¾è®¯é‚®ç®±å‘é€, åœ¨ settings é‡Œé¢[è®¾ç½®](https://juejin.im/post/6844904030729142285), ä¹Ÿå¯ä»¥[å‚è€ƒ](https://www.cnblogs.com/hester/p/10540553.html):

```python
EMAIL_USE_SSL = True
EMAIL_HOST = 'smtp.qq.com'
EMAIL_PORT = 465
EMAIL_HOST_USER = 'xxx@qq.com'
EMAIL_HOST_PASSWORD = 'xxxxx'  # os.environ.get('EMAIL_PASSWORD')
DEFAULT_FROM_EMAIL = EMAIL_HOST_USER
```

ä¸ºäº†å®‰å…¨èµ·è§, ä¸è¦å°†å¯†ç è°¢åœ¨è¿™é‡Œ, æœ€åŸºæœ¬çš„ä¹Ÿè¦ä½¿ç”¨ç¯å¢ƒå˜é‡:

linux/mac:
```bash
export EMAIL_HOST_PASSWORD="mima"
```

ç¡®ä¿å‘é€çš„é‚®ç®±å’Œæ³¨å†Œé‚®ç®±ä¸€è‡´, ç„¶åå°±å®Œæˆäº†!ğŸ˜ƒ

ä¸è¿‡æˆ‘ä»¬è‚¯å®šä¼šæƒ³è‡ªå®šä¹‰æ¨¡æ¿çš„, æ‰€ä»¥è¿˜æ˜¯åˆ›å»ºå¦‚ä¸‹æ¨¡æ¿:

```bash
templates/registration/password_reset_form.html
templates/registration/password_reset_done.html
templates/registration/password_reset_confirm.html
templates/registration/password_reset_complete.html
templates/registration/password_reset_email.html
templates/registration/password_reset_subject.txt
```

è¿™é‡Œä¹Ÿéœ€è¦å…ˆåŠŸèƒ½æµ‹è¯•, å†å†™æ¨¡æ¿. åŸºæœ¬éƒ½ä¸éš¾, ä½†æ˜¯å‘é‚®ä»¶æ”¶é‚®ä»¶æ€ä¹ˆå†™?

## mock

ç°åœ¨æœ‰ä¸€ä¸ªé—®é¢˜, å°±ç®—æ˜¯åŠŸèƒ½æµ‹è¯•, æˆ‘è¿˜å¾—å»ç™»å½•é‚®ç®±æ¥éªŒè¯æ˜¯å¦å‘é€é‚®ä»¶æˆåŠŸå—?

### ä½¿ç”¨

```bash
[pytest]
DJANGO_SETTINGS_MODULE = superlists.test_settings
addopts = --no-migrations --cov=. --cov-report=html
```

test_setting.py:

[email ç›¸å…³](https://docs.djangoproject.com/en/3.0/topics/email/#in-memory-backend)
```python
from .settings import *

DATABASES = {
        "default": {
        "ENGINE": "django.db.backends.sqlite3" } }  # ä½¿ç”¨å†…å­˜æ•°æ®åº“
        
EMAIL_BACKEND = 'django.core.mail.backends.locmem.EmailBackend'
```


è¿™é‡Œä½¿ç”¨äº† `from django.core import mail`

åŠŸèƒ½æµ‹è¯•:
```python
import pytest
from django.core import mail
import time

from .utils.helpers import UserMixin

class TestPasswordChangeReset(UserMixin):

...

    def test_password_reset(self, live_server, user, password):
        self.live_server = live_server

        # ç™»å½•ç”¨æˆ·
        self.login(user, password) 

        # é‡ç½®å¯†ç 
        self.browser.get(self.live_server.url + '/accounts/password_reset/')
        self.browser.find_element_by_id('id_email').send_keys(user.email)
        self.browser.find_element_by_xpath('/html/body/div/form/input[2]').click()

        email = mail.outbox[0]
        assert user.email in email.to

        self.browser.get(self.live_server.url + '/accounts/password_reset/')
        self.browser.find_element_by_id('id_email').send_keys('other@a.com')
        self.browser.find_element_by_xpath('/html/body/div/form/input[2]').click()

        email = mail.outbox[0]
        assert 'other@a.com' not in email.to
```

å› ä¸ºé‚®ä»¶å†…å®¹ä¸æ˜¯æˆ‘ä»¬åšçš„, æ‰€æœ‰ä¸ç”¨æµ‹è¯•äº†. è€Œä¸”å¯†ç é‡ç½®ä¹Ÿä¸æ˜¯æˆ‘ä»¬è‡ªå·±åšçš„, ä¹Ÿä¸ç”¨æµ‹è¯•äº†.

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è‡ªå·±å†™çš„æ¨¡æ¿æœ‰:

```bash
accounts/templates
â”œâ”€â”€ accounts
â”‚   â””â”€â”€ signup.htmld
â””â”€â”€ registration
    â”œâ”€â”€ login.html
    â”œâ”€â”€ password_change_done.html
    â”œâ”€â”€ password_change_form.html
    â”œâ”€â”€ password_reset_complete.html
    â”œâ”€â”€ password_reset_confirm.html
    â”œâ”€â”€ password_reset_done.html
    â””â”€â”€ password_reset_form.html
```
