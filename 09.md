# ç”¨æˆ·ç®¡ç†

Django æä¾›äº†åŸºæœ¬çš„ä½†æ˜¯åŠŸèƒ½å¼ºå¤§çš„ç”¨æˆ·ç®¡ç†èƒ½åŠ›, å…¶å®˜æ–¹å»ºè®®æ–°å»ºçš„é¡¹ç›®ä½¿ç”¨è‡ªå®šä¹‰çš„ User Model. 

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç®€å•çš„ `AbstractUser` æ¥å®ç°.

æˆ‘ä»¬æœŸæœ›åœ¨ä¸»é¡µæœ‰ç™»å½•ç™»å‡ºæŒ‰é’®, è½¬åˆ°ç›¸åº”é¡µé¢, ç™»å½•åè½¬åˆ°ç”¨æˆ·è‡ªå·±çš„é¡µé¢.

ç°åœ¨è™½ç„¶ä¸çŸ¥é“å…·ä½“åŠŸèƒ½æ€ä¹ˆå†™, ä½†æ˜¯éœ€æ±‚è¿˜æ˜¯çŸ¥é“çš„, æ‰€ä»¥å¯ä»¥æ ¹æ®éœ€æ±‚å†™åŠŸèƒ½æµ‹è¯•.

## åŠŸèƒ½æµ‹è¯•
```python åŠŸèƒ½æµ‹è¯•
import pytest
import time


def homepage_non_login_user_navbar_responsive_design(browser, live_server):

    # ä»–æ‰“å¼€ç½‘ç«™çš„ä¸»é¡µ
    browser.get(live_server.url)
    browser.set_window_size(1024, 768)

    # ä»–å‘ç°ä¸»é¡µ, æ³¨å†Œ, ç™»å½•é“¾æ¥
    links = browser.find_elements_by_css_selector('li>a.nav-link')
    texts = [link.text for link in links]

    assert 'ä¸»é¡µ' in texts
    assert 'æ³¨å†Œ' in texts
    assert 'ç™»å½•' in texts
    assert 'é€€å‡º' not in texts

    time.sleep(1)
    assert all(link.is_displayed() for link in links) is True


    # ä»–ç¼©å°å±å¹•å°ºå¯¸
    browser.set_window_size(500, 768)

    # æ— æ³•å‘ç°ä¸»é¡µ, æ³¨å†Œ, ç™»å½•é“¾æ¥
    time.sleep(1)
    assert all(link.is_displayed() for link in links) is False

    # ç‚¹å‡»å¼€å…³æŒ‰é’®, å‘ç°äº†é‚£äº›é“¾æ¥
    toggler = browser.find_element_by_css_selector('.navbar-toggler')
    toggler.click()
    time.sleep(1)
    assert all(link.is_displayed() for link in links) is True

    # ç‚¹å‡»å¼€å…³æŒ‰é’®, åˆçœ‹ä¸åˆ°é‚£äº›é“¾æ¥
    toggler.click()
    time.sleep(1)
    assert all(link.is_displayed() for link in links) is False


def test_homepage_signup_login_logout(browser, live_server):
    # ä»–æ‰“å¼€ç½‘ç«™çš„ä¸»é¡µ
    browser.get(live_server.url)
    browser.set_window_size(1024, 768) 

    user = 'user'
    email = 'user@user.com'
    password = 'StorngPass332211'

    # ç‚¹å‡»æ³¨å†Œ
    browser.find_element_by_id('signup').click()
    browser.find_element_by_id('id_username').send_keys(user)
    browser.find_element_by_id('id_email').send_keys(email)
    browser.find_element_by_id('id_age').send_keys('10')
    browser.find_element_by_id('id_password1').send_keys(password)
    browser.find_element_by_id('id_password2').send_keys(password)
    browser.find_element_by_tag_name('button').click()

    # ç™»å½•
    browser.find_element_by_id('id_username').send_keys(user)
    browser.find_element_by_id('id_password').send_keys(password)
    browser.find_element_by_tag_name('button').click()

    links = browser.find_elements_by_css_selector('li>a.nav-link')
    texts = [link.text for link in links]

    assert 'ä¸»é¡µ' in texts
    assert 'æ³¨å†Œ' not in texts
    assert 'ç™»å½•' not in texts
    assert 'é€€å‡º' in texts

    time.sleep(1)
    assert all(link.is_displayed() for link in links) is True

    # é€€å‡º
    browser.find_element_by_id('logout').click()
    links = browser.find_elements_by_css_selector('li>a.nav-link')
    texts = [link.text for link in links]
    assert 'ä¸»é¡µ' in texts
    assert 'æ³¨å†Œ' in texts
    assert 'ç™»å½•' in texts
    assert 'é€€å‡º' not in texts

    time.sleep(1)
    assert all(link.is_displayed() for link in links) is True
```

## æ¨¡å‹

### å‰æœŸå‡†å¤‡
åˆ›å»ºä¸€ä¸ªæ–°çš„ django åº”ç”¨:

```bash
python manage.py startapp accounts
```

è®¾ç½®settings.py:

```python
INSTALLED_APPS = [
    ...
    'lists.apps.ListsConfig',
    'accounts.apps.AccountsConfig',
    ]
...
AUTH_USER_MODEL = 'accounts.Account'
```

### è‡ªå®šä¹‰ç”¨æˆ·æ¨¡å‹

åŸºæœ¬å®ç°çš„æµ‹è¯• accounts/tests/model_test.py:

```python
import pytest

from ..models import Account


@pytest.mark.django_db
class TestAccountModel:
    def test_create_account_should_basically_right(self):
        password = 'IamStrong7352'
        account = Account.objects.create_user(username='aaa', password=password, email='aaa@aaa.com')

        assert account.username == 'aaa'
        assert account.is_active == True
        assert account.is_staff == False
        assert account.is_superuser == False

        assert account.email == 'aaa@aaa.com'

    def test_create_account_should_set_right_age(self):
        password = 'IamStrong7352'
        account = Account.objects.create_user(username='aaa', password=password, email='aaa@aaa.com')

        assert account.age is None

        account.age = 10
        account.save()

        saved_account = Account.objects.first()
        assert saved_account.age == 1
```

accounts/models.py:

```python
from django.db import models
from django.contrib.auth.models import AbstractUser


class CustomUser(AbstractUser):
    age = models.PositiveIntegerField(null=True, blank=True)  # ğŸ˜ˆ
    first_name = None  # ğŸ
    last_name = None
```
* ğŸ˜ˆ: åŠ å…¥å¹´é¾„. `null` ä¸æ•°æ®åº“æœ‰å…³. `null=True` è¯´æ˜å¯ä»¥å­˜å‚¨ç©ºå€¼ä¸º `NULL`. `blank` ä¸éªŒè¯æœ‰å…³. `blank=True` è¯´æ˜å¯ä»¥ä¸å¡«.
* ğŸ: è¿™ä¸¤è¡Œè¯´æ˜ä¸éœ€è¦ `first_name` å’Œ `last_name`. å¦‚æœæŸ¥çœ‹ migration ä¿¡æ¯, å¯ä»¥å‘ç°:

```python
operations = [
        migrations.CreateModel(
            name='Account',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('password', models.CharField(max_length=128, verbose_name='password')),
                ('last_login', models.DateTimeField(blank=True, null=True, verbose_name='last login')),
                ('is_superuser', models.BooleanField(default=False, help_text='Designates that this user has all permissions without explicitly assigning them.', verbose_name='superuser status')),
                ('username', models.CharField(error_messages={'unique': 'A user with that username already exists.'}, help_text='Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.', max_length=150, unique=True, validators=[django.contrib.auth.validators.UnicodeUsernameValidator()], verbose_name='username')),
                ('email', models.EmailField(blank=True, max_length=254, verbose_name='email address')),
                ('is_staff', models.BooleanField(default=False, help_text='Designates whether the user can log into this admin site.', verbose_name='staff status')),
                ...
```

æ²¡æœ‰å§“åä¿¡æ¯. 

> æˆ‘æ€ä¹ˆçŸ¥é“ `AbstractUser` é‡Œé¢æœ‰å•¥å‘¢? æŸ¥çœ‹æºä»£ç :

```python
class AbstractUser(AbstractBaseUser, PermissionsMixin):
    """
    An abstract base class implementing a fully featured User model with
    admin-compliant permissions.

    Username and password are required. Other fields are optional.
    """
    username_validator = UnicodeUsernameValidator()

    username = models.CharField(
        _('username'),
        max_length=150,
        unique=True,
        help_text=_('Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.'),
        validators=[username_validator],
        error_messages={
            'unique': _("A user with that username already exists."),
        },
    )
    first_name = models.CharField(_('first name'), max_length=30, blank=True)
    last_name = models.CharField(_('last name'), max_length=150, blank=True)
    email = models.EmailField(_('email address'), blank=True)
    ...
```

éœ€è¦èƒ½å¤Ÿæ–°å»ºå’Œä¿®æ”¹è´¦å·çš„åŠŸèƒ½:

å•å…ƒæµ‹è¯•:

```python
import pytest

from ..forms import AccountCreationForm, AccountChangeForm


@pytest.mark.django_db
class TestAccountCreationForm():
    def test_AccountCreationFrom_normal_input_should_be_valid(self):
        password = 'IamStrong321'
        form = AccountCreationForm(data={
            'username': 'aaa',
            'email': 'a@a.com',
            'age': 10,
            'password1': password,
            'password2': password})
        
        assert form.is_valid() == True

    def test_empty_AccountCreationForm_should_be_in_valid(self):
        form = AccountCreationForm()
        assert form.is_valid() == False

@pytest.mark.django_db
class TestAccountChangeForm():
    def test_empty_AccountChangeForm_should_be_in_valid(self):
        form = AccountChangeForm()
        assert form.is_valid() == False

    def test_AccountChangeFrom_normal_input_should_be_valid(self):
        form = AccountChangeForm(data={
            'age': 10,
            })
        
        assert form.is_valid() == True
```

å¯¹åº”çš„ä»£ç :
```python
from django import forms
from django.contrib.auth.forms import UserCreationForm, UserChangeForm

from .models import Account


class AccountCreationForm(UserCreationForm):
    class Meta(UserCreationForm):
        model = Account
        fields = ('username', 'email', 'age', 'password1', 'password2')

class AccountChangeForm(UserChangeForm):
    class Meta(UserChangeForm):
        model = Account
        fields = ('age', )
```

### ç®¡ç†å‘˜

ä¸‹ä¸€æ­¥éœ€è¦ç”¨åˆ° Django çš„ç®¡ç†å‘˜åŠŸèƒ½äº†. è¿™ä¸ªåŠŸèƒ½ä¸ Django å†…ç½®çš„ User æ¨¡å‹ç»‘å®š, æˆ‘ä»¬éœ€è¦ä¿®æ”¹å®ƒ, è®©å®ƒå¯ä»¥ç”¨æˆ‘ä»¬çš„ Account ç±».

```python
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin

from .forms import AccountChangeForm, AccountCreationForm
from .models import Account


class AccountAdmin(UserAdmin):
    add_form = AccountCreationForm
    form = AccountChangeForm
    model = Account
    list_display = ['email', 'username', 'age', 'is_staff', ]
    fieldsets = (
        (None, {'fields': ('email', 'password')}),
        ('Permissions', {'fields': ('is_staff', 'is_active')}),
    )
    add_fieldsets = (
        (None, {
            'classes': ('wide',),
            'fields': ('email', 'username', 'password1', 'password2', 'is_staff', 'is_active')}
        ),
    )

admin.site.register(Account, AccountAdmin)
```

ç¨ç­‰è§‚å¯Ÿç•Œé¢, å°±çŸ¥é“è¿™äº›æ˜¯ä»€ä¹ˆäº†. ä¸è¿‡, é¦–å…ˆåˆ é™¤åŸå…ˆçš„æ•°æ®åº“, ç„¶å:

```bash
python manage.py makemigrations 
python manage.py migrate     
```

æ¥ç€æ–°å»ºä¸€ä¸ªè¶…çº§ç”¨æˆ·:

```bash
python manage.py createsuperuser
```

æŒ‰ç…§è¦æ±‚è¾“å…¥å°±å¯ä»¥äº†. æœ€åè¿è¡ŒæœåŠ¡å™¨, ç™»å½• "http://127.0.0.1:8000/admin", å°±å¯ä»¥çœ‹åˆ°æ•ˆæœäº†.        
ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ç”¨æˆ·æ¨¡å‹, æ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹ç™»å½•æ³¨å†Œç­‰äº†. Django æä¾›ç»™äº†æˆ‘ä»¬ç™»å½•ç™»å‡ºçš„åŠŸèƒ½, ä¸è¿‡æˆ‘ä»¬éœ€è¦è‡ªå·±å†™æ³¨å†Œè¡¨å•.

## ç”¨æˆ·éªŒè¯ View
Django é»˜è®¤ä¼šå» `registration` æ–‡ä»¶å¤¹å»æ‰¾å…³äºç”¨æˆ·éªŒè¯çš„æ¨¡æ¿. ä¸è¿‡è¿™éƒ¨åˆ†å†…å®¹æˆ‘å¹¶ä¸ç†Ÿæ‚‰, æ‰€ä»¥å¾—å…ˆè¯•ä¸€è¯•

### å°è¯•æ€§ç¼–ç¨‹

ä¸æ‡‚æ€ä¹ˆåš, ç›®çš„æ˜¯å®éªŒåŠŸèƒ½, æš‚æ—¶ä¸åšæµ‹è¯•, è¿™ç§åŸå‹å¼€å‘è¿‡ç¨‹æ˜¯ä¸€ç§ "å°–å³°". å¯¹å…¶è¿›è¡Œçš„æµ‹è¯•å°±æ˜¯ "å»å³°".

æ ¹æ® django æ–‡æ¡£æŸ¥é˜…, æ–‡ä»¶ç»“æ„å¤§æ¦‚åº”è¯¥è¿™æ ·çš„:

```bash
é¡¹ç›®æ ¹ç›®å½•/
â”‚
...
â”œâ”€â”€ accounts/
â”‚   â”‚
â”‚   â”œâ”€â”€ templates/
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ registration/  â† Templates used by Django user management
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ accounts/  â† Other templates of your application
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ base.html  â† The base template of your application
â”‚   â”‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ admin.py
...
â”‚   â””â”€â”€ views.py
...
â””â”€â”€ manage.py
```

urls.py:
```python
urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('lists.urls')),
    path('accounts/', include('accounts.urls')),  # django ä¸æä¾›æ³¨å†ŒåŠŸèƒ½, è‡ªå·±å†™
    path('accounts/', include('django.contrib.auth.urls')),  # å…¶ä»–åŠŸèƒ½ django éƒ½æä¾›, ç›´æ¥ç”¨
]
```

accounts/urls.py:

```python
from django.urls import path

from .views import SignUpView

app_name = 'accounts'  # æä¾› app åç§°, æ–¹ä¾¿ç´¢å¼•

urlpatterns = [
    path('signup/', SignUpView.as_view(), name='signup'), 
]
```

ç™»å½•ç™»å‡ºé¡µé¢è®¾ç½®, settings.py:

```python
LOGIN_REDIRECT_URL = 'home'
LOGOUT_REDIRECT_URL = 'home'
```


ä¿®æ”¹ä¸»é¡µæ¨¡æ¿, lists/base.html:

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šæ—¥æ¸…å•</title>
    <link rel="stylesheet" href="/static/bootstrap-4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/base.css">
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <a class="navbar-brand" href="#">ä»Šæ—¥æ¸…å•</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item active">
        <a class="nav-link" href="#">ä¸»é¡µ</span></a>
      </li>
      {% if user.is_authenticated %}
      <li class="nav-item">
        <span class="navbar-text">
          {{ user.username}}, ä½ å¥½!
        </span>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'logout' %}" id="logout">é€€å‡º</a>
      </li>
      {% else %}
        <li class="nav-item">
          <a class="nav-link" href="{% url 'accounts:signup' %}" id="signup">æ³¨å†Œ</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'login' %}" id="login">ç™»å½•</a>
        </li>
      {% endif %} 
    </ul>
  </div>
</nav>
...
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</body>
</html>
```

ç›¸åº”çš„ views.py. è¿™é‡Œä½¿ç”¨ django çš„åŸºäºç±»çš„ view:

```python
from django.urls import reverse_lazy
from django.views.generic import CreateView

from .forms import AccountCreationForm


class SignUpView(CreateView):
    form_class = AccountCreationForm
    success_url = reverse_lazy('login')
    template_name = 'accounts/signup.html'
```

> è‡³äºä¸ºä»€ä¹ˆ `reverse_lazy`, å‚è€ƒ: [Stack Overflow](https://stackoverflow.com/questions/48669514/difference-between-reverse-and-reverse-lazy-in-django), [å®˜æ–¹æ–‡æ¡£](https://docs.djangoproject.com/en/3.0/ref/urlresolvers/#reverse-lazy)

åŠŸèƒ½æµ‹è¯•åé€šè¿‡. æµè§ˆå™¨è¯•è¯•, å‘ç°å¯ä»¥å·¥ä½œæ­£å¸¸äº†. ä¸‘ä¸ä¸‘çš„å°±ä¸è¦ç®¡äº†, èƒ½ç”¨å°±è¡Œäº†.

### å»å³°
ç°åœ¨æˆ‘ä»¬å·²ç»å®Œæˆäº†åŸºæœ¬åŠŸèƒ½, æˆ‘ä»¬åšäº†çš„å·¥ä½œæœ‰:

* è®¾ç½®è·¯ç”±
* è®¾ç½®è·³è½¬ä½ç½®
* é…ç½® `SignupView`

å¯¹åº”çš„æµ‹è¯•: 

```python
from django.urls import resolve, reverse
from pytest_django.asserts import assertTemplateUsed, assertRedirects, assertContains
import pytest

from ..forms import AccountCreationForm

@pytest.mark.django_db
class TestSignup:

    def test_signup_page_uses_AccountCreationForm(self, client):
        response = client.get(reverse('accounts:signup'))
        assert isinstance(response.context['form'], AccountCreationForm) == True

    def test_signup_success_redirects_to_longin_page(self, client):
        password = 'StrongPass321'
        response = client.post(reverse('accounts:signup'), data={
            'username': 'user',
            'email': 'user@use.com',
            'age': '10',
            'password1': password,
            'password2': password,
            })
        assertRedirects(response, reverse('login'))
        
    def test_signup_use_signup_template(self, client):
        response = client.get(reverse('accounts:signup'))
        assertTemplateUsed(response, 'accounts/signup.html')
```

